<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di Di Coffee - Ki·ªÉm Tra ƒêi·ªÉm</title>
    <link rel="stylesheet" href="style.css">
    <script src="hoamai.js"></script>
</head>
<body>
    <div class="card">
        <canvas id="flower-canvas"></canvas>
        <h2 id="shopTitle">‚òï DI DI COFFEE</h2>
        
        <div id="form-input">
            <h3 style="color: #5d4037; margin-bottom: 15px;">TRA C·ª®U ƒêI·ªÇM T√çCH L≈®Y</h3>
            
            <label>S·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng:</label>
            <input type="tel" id="cusPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ xem ƒëi·ªÉm">
            
            <button id="btnCheck" onclick="handleCheckPoint()">KI·ªÇM TRA NGAY</button>
            
            <br><br>
            <span style="color:#5d4037;font-weight:bold;">Hotline: 0968.97.37.87</span>
        </div>

        <div id="result"></div>        
        
        <div class="nav-menu">
            <a href="index.html" class="nav-item"><i>‚≠ê</i> T√≠ch ƒëi·ªÉm</a>
            <a href="doi-qua.html?from=web" class="nav-item"><i>üéÅ</i> ƒê·ªïi qu√†</a>
            <a href="vong-quay.html" class="nav-item"><i>üé°</i> Quay th∆∞·ªüng</a>
            <a href="quatet.html" class="nav-item active"><i>üìä</i> Xem ƒëi·ªÉm</a>
        </div>
    </div>

<script src="config.js"></script> 
<script>
    /* ============================================================
       LOGIC: T·ª∞ ƒê·ªòNG ƒêI·ªÄN SƒêT V√Ä KI·ªÇM TRA ƒêI·ªÇM (ƒê·ªíNG B·ªò STYLE)
       ============================================================ */
    window.onload = function() {
        // 1. C·∫≠p nh·∫≠t t√™n Shop t·ª´ config
        if (typeof CONFIG !== 'undefined' && CONFIG.SHOP_NAME) {
            document.getElementById('shopTitle').innerText = "‚òï " + CONFIG.SHOP_NAME;
        }

        // 2. L·∫•y SƒêT t·ª´ URL (d√†nh cho QR Code: quatet.html?sdt=0366...)
        const urlParams = new URLSearchParams(window.location.search);
        const sdtFromURL = urlParams.get('sdt');
        
        // 3. L·∫•y SƒêT t·ª´ localStorage (ƒë√£ l∆∞u ·ªü trang index.html)
        const savedPhone = localStorage.getItem('didi_customer_phone');

        const phoneInput = document.getElementById('cusPhone');

        if (sdtFromURL) {
            phoneInput.value = sdtFromURL;
            handleCheckPoint(); // C√≥ SƒêT t·ª´ QR -> T·ª± ƒë·ªông ki·ªÉm tra lu√¥n
        } else if (savedPhone) {
            phoneInput.value = savedPhone;
            // N·∫øu mu·ªën t·ª± ƒë·ªông ki·ªÉm tra lu√¥n khi v√†o trang m√† c√≥ SƒêT c≈©:
            // handleCheckPoint(); 
        }
    };

    function handleCheckPoint() {
        const phone = document.getElementById('cusPhone').value.trim();
        const resultDiv = document.getElementById('result');
        const btnCheck = document.getElementById('btnCheck');

        if (!phone) {
            resultDiv.innerHTML = "<div class='error'>‚ùå Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!</div>";
            return;
        }

        // Hi·ªáu ·ª©ng ƒëang x·ª≠ l√Ω ƒë·ªìng b·ªô v·ªõi style index.html
        btnCheck.disabled = true;
        btnCheck.innerHTML = "‚åõ ƒêang tra c·ª©u...";
        resultDiv.innerHTML = "";

        // L∆∞u SƒêT l·∫°i ƒë·ªÉ l·∫ßn sau kh√¥ng ph·∫£i nh·∫≠p
        localStorage.setItem('didi_customer_phone', phone);

        // G·ªçi API tra c·ª©u (S·ª≠ d·ª•ng chung SCRIPT_URL trong config.js)
        // L∆∞u √Ω: GAS c·ªßa b·∫°n c·∫ßn c√≥ action 'check_point' ho·∫∑c t∆∞∆°ng ƒë∆∞∆°ng
        window.googleCallback = function(resData) {
            btnCheck.disabled = false;
            btnCheck.innerHTML = "KI·ªÇM TRA NGAY";
            
            if (resData.status === "SUCCESS" || resData.points !== undefined) {
                if (navigator.vibrate) navigator.vibrate(100);
                
                resultDiv.innerHTML = `
                    <div class="success-box">
                        <div style="font-size: 1.1em; margin-bottom: 5px;">Ch√†o b·∫°n, <b>${resData.name || 'Kh√°ch h√†ng'}</b></div>
                        <span class="points-info">S·ªë ƒëi·ªÉm t√≠ch l≈©y: <span style="font-size: 2em;">${resData.points}</span></span>
                        <div style="margin-top: 10px; font-size: 0.8em; opacity: 0.8;">C·∫≠p nh·∫≠t l√∫c: ${new Date().toLocaleTimeString('vi-VN')}</div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = "<div class='error'>‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒëi·ªÉm c·ªßa s·ªë n√†y!</div>";
            }
            
            const oldScript = document.getElementById('api-call');
            if (oldScript) oldScript.remove();
        };

        const scriptTag = document.createElement("script");
        scriptTag.id = "api-call";
        // G·ª≠i action=check_point t·ªõi Google Script
        scriptTag.src = `${CONFIG.SCRIPT_URL}?action=check_point&phone=${encodeURIComponent(phone)}&callback=googleCallback&t=${new Date().getTime()}`;
        
        scriptTag.onerror = function() {
            btnCheck.disabled = false;
            btnCheck.innerHTML = "KI·ªÇM TRA NGAY";
            resultDiv.innerHTML = "<div class='error'>‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß!</div>";
        };
        document.body.appendChild(scriptTag);
    }
</script>
</body>
</html>
