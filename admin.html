function doGet(e) {
  // --- 1. THI·∫æT L·∫¨P KH√ìA (CH·ªêNG BUG QUAY NHI·ªÄU M√ÅY) - GI·ªÆ NGUY√äN ---
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(20000); 

    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var action = e.parameter.action;
    
    // L√†m s·∫°ch s·ªë ƒëi·ªán tho·∫°i truy·ªÅn t·ª´ URL - GI·ªÆ NGUY√äN
    var phone = e.parameter.phone ? e.parameter.phone.toString().replace(/[^0-9]/g, "") : "";

    // Ch·ªëng d·ªØ li·ªáu r·ªóng - GI·ªÆ NGUY√äN (C·∫≠p nh·∫≠t th√™m c√°c action m·ªõi)
    if (!action || (action !== "get_points" && action !== "admin_get_info" && action !== "admin_get_all_customers" && !phone)) {
      return ContentService.createTextOutput("IGNORE_EMPTY_REQUEST");
    }

    // --- 2. X·ª¨ L√ù XEM ƒêI·ªÇM - GI·ªÆ NGUY√äN ---
    if (action === "get_points") {
      var total = calculateTotalPoints(phone, sheet);
      return ContentService.createTextOutput(total.toString());
    }

    // --- 3. ADMIN: L·∫§Y TO√ÄN B·ªò DANH S√ÅCH KH√ÅCH (M·ªöI) ---
    if (action === "admin_get_all_customers") {
      var data = sheet.getDataRange().getValues();
      var customers = {}; 
      for (var i = 1; i < data.length; i++) {
        var name = data[i][2] || "Kh√°ch ·∫©n danh";
        var rawPhone = data[i][3] ? data[i][3].toString().replace(/[^0-9]/g, "") : "";
        var type = data[i][1] ? data[i][1].toString().toUpperCase() : "";
        var pts = Number(data[i][5]) || 0;
        if (rawPhone) {
          if (!customers[rawPhone]) { customers[rawPhone] = { name: name, points: 0 }; }
          if (name !== "Kh√°ch ·∫©n danh") customers[rawPhone].name = name;
          if (type === "ƒê√É D√ôNG") {
            customers[rawPhone].points += (pts === 0 ? 1 : pts);
          } else if (type === "ƒê·ªîI TH∆Ø·ªûNG") {
            customers[rawPhone].points -= pts;
          }
        }
      }
      var list = [];
      for (var p in customers) {
        list.push({ phone: p, name: customers[p].name, points: Math.round(customers[p].points * 100) / 100 });
      }
      var res = JSON.stringify({ "status": "SUCCESS", "data": list });
      return ContentService.createTextOutput(e.parameter.callback + "(" + res + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
    }

    // --- 4. ADMIN: TRA C·ª®U 1 KH√ÅCH (M·ªöI) ---
    if (action === "admin_get_info") {
      var total = calculateTotalPoints(phone, sheet);
      var data = sheet.getDataRange().getValues();
      var customerName = "Kh√°ch m·ªõi";
      for (var i = data.length - 1; i >= 1; i--) {
        var phoneInSheet = data[i][3] ? data[i][3].toString().replace(/[^0-9]/g, "") : "";
        if (phoneInSheet === phone && data[i][2]) {
          customerName = data[i][2];
          break;
        }
      }
      var res = JSON.stringify({ "status": "SUCCESS", "name": customerName, "points": total });
      return ContentService.createTextOutput(e.parameter.callback + "(" + res + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
    }

    // --- 5. ADMIN: C·ªòNG/TR·ª™ ƒêI·ªÇM (M·ªöI) ---
    if (action === "admin_update_points") {
      var mode = e.parameter.mode; 
      var amount = Number(e.parameter.amount) || 0;
      var adminName = e.parameter.name || "Admin";
      var note = e.parameter.note || (mode === "add" ? "C·ªông ƒëi·ªÉm th·ªß c√¥ng" : "ƒê·ªïi qu√† t·∫°i qu·∫ßy");
      var statusFlag = (mode === "add") ? "ƒê√É D√ôNG" : "ƒê·ªîI TH∆Ø·ªûNG";
      sheet.appendRow(["ADMIN_MANUAL", statusFlag, adminName, "'" + phone, new Date(), amount]);
      var newTotal = calculateTotalPoints(phone, sheet);
      sendTelegramSpin(adminName + " - " + phone, note + " (" + (mode === "add" ? "+" : "-") + amount + "ƒë)");
      var res = JSON.stringify({ "status": "SUCCESS", "points": newTotal });
      return ContentService.createTextOutput(e.parameter.callback + "(" + res + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
    }

    // --- 6. X·ª¨ L√ù ƒê·ªîI TH∆Ø·ªûNG / V√íNG QUAY - GI·ªÆ NGUY√äN ---
    if (action === "doi_thuong" || action === "vong_quay") {
      var gift = e.parameter.gift || "Qu√† t·∫∑ng";
      var pointsToSubtract = Number(e.parameter.points) || 0; 
      var currentPoints = calculateTotalPoints(phone, sheet);
      if (currentPoints < pointsToSubtract) { return ContentService.createTextOutput("ERROR_NOT_ENOUGH_POINTS"); }
      
      var data = sheet.getDataRange().getValues();
      var tempName = "Kh√°ch";
      for (var i = data.length - 1; i >= 1; i--) {
        if (data[i][3].toString().replace(/[^0-9]/g, "") === phone) { tempName = data[i][2]; break; }
      }
      sheet.appendRow([action.toUpperCase(), "ƒê·ªîI TH∆Ø·ªûNG", gift, "'" + phone, new Date(), pointsToSubtract]);
      sendTelegramSpin(tempName + " - " + phone, gift + " (Tr·ª´ " + pointsToSubtract + "ƒë)");
      return ContentService.createTextOutput("SUCCESS");
    }

    // --- 7. X·ª¨ L√ù T√çCH ƒêI·ªÇM QR - GI·ªÆ NGUY√äN ---
    var code = e.parameter.code ? e.parameter.code.toUpperCase().trim() : "";
    if (!code || code === "") { return ContentService.createTextOutput("EMPTY_CODE_IGNORE"); }
    var name = e.parameter.name || "Kh√°ch ·∫©n danh";
    var phoneInput = e.parameter.phone || "";
    var pointsToAdd = Number(e.parameter.add_points) || 1;
    var data = sheet.getDataRange().getValues();
    var status = "NOT_FOUND";
    var totalPoints = 0;
    for (var i = 1; i < data.length; i++) {
      if (data[i][0].toString().toUpperCase().trim() == code) {
        if (data[i][1] == "ƒê√É D√ôNG") { status = "USED"; } 
        else {
          sheet.getRange(i + 1, 2).setValue("ƒê√É D√ôNG");
          sheet.getRange(i + 1, 3).setValue(name);
          sheet.getRange(i + 1, 4).setValue("'" + phoneInput.toString().replace(/[^0-9]/g, ""));
          sheet.getRange(i + 1, 5).setValue(new Date());
          sheet.getRange(i + 1, 6).setValue(pointsToAdd);
          status = "SUCCESS";
        }
        break;
      }
    }
    if (status === "SUCCESS" || status === "USED") {
      totalPoints = calculateTotalPoints(phoneInput, sheet);
      if (status === "SUCCESS") {
        var today = new Date().toLocaleDateString();
        var dailyCount = 0;
        var updatedData = sheet.getDataRange().getValues();
        for (var j = 1; j < updatedData.length; j++) {
          if (updatedData[j][4] instanceof Date && updatedData[j][4].toLocaleDateString() == today) { dailyCount++; }
        }
        sendTelegramScan(name, phoneInput, code, totalPoints, dailyCount);
      }
    }
    var result = JSON.stringify({ "status": status, "points": totalPoints });
    return ContentService.createTextOutput(e.parameter.callback + "(" + result + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);

  } catch (err) {
    var errResult = JSON.stringify({"status":"ERROR", "message": err.toString()});
    return ContentService.createTextOutput(e.parameter.callback + "(" + errResult + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  } finally {
    lock.releaseLock(); // GI·ªÆ NGUY√äN NH·∫¢ KH√ìA
  }
}

// --- H√ÄM T√çNH T·ªîNG ƒêI·ªÇM - GI·ªÆ NGUY√äN ---
function calculateTotalPoints(phone, sheet) {
  if (!phone) return 0;
  var phoneClean = phone.toString().replace(/[^0-9]/g, "");
  var data = sheet.getDataRange().getValues();
  var total = 0;
  for (var i = 1; i < data.length; i++) {
    var phoneInSheet = data[i][3] ? data[i][3].toString().replace(/[^0-9]/g, "") : "";
    if (phoneInSheet === phoneClean) {
      var type = data[i][1] ? data[i][1].toString().toUpperCase() : "";
      if (type === "ƒê√É D√ôNG") {
        var pts = Number(data[i][5]);
        total += (isNaN(pts) || pts === 0) ? 1 : pts;
      } else if (type === "ƒê·ªîI TH∆Ø·ªûNG") {
        var pts = Number(data[i][5]);
        total -= (isNaN(pts) ? 0 : pts);
      }
    }
  }
  return Math.round(total * 100) / 100;
}

// --- TELEGRAM (ƒê√É S·ª¨A ƒê·ªäNH D·∫†NG T√äN - SƒêT) ---
function sendTelegramScan(name, phone, code, points, dailyCount) {
  var token = "8537370635:AAFoEKrQDGdbF9Lu07_m8TuVPZlVKETrnBw"; 
  var chatId = "2102561624";
  var message = "‚òï *DI DI COFFEE - C√ì KH√ÅCH M·ªöI!*\nüë§: *" + name + " - " + phone + "*\nüé´: `" + code + "`\n‚≠ê ƒêi·ªÉm t√≠ch l≈©y: *" + points + "*\nüìä T·ªïng kh√°ch h√¥m nay: *" + dailyCount + "*";
  UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendMessage?chat_id=" + chatId + "&text=" + encodeURIComponent(message) + "&parse_mode=Markdown");
}

function sendTelegramSpin(customerInfo, gift) {
  var token = "8537370635:AAFoEKrQDGdbF9Lu07_m8TuVPZlVKETrnBw"; 
  var chatId = "2102561624";
  var msg = "üéÅ *DI DI COFFEE - ƒê·ªîI QU√Ä/V√íNG QUAY*\nüë§ Kh√°ch: *" + customerInfo + "*\nüéâ N·ªôi dung: *" + gift + "*\n‚è∞ L√∫c: " + new Date().toLocaleString();
  UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendMessage?chat_id=" + chatId + "&text=" + encodeURIComponent(msg) + "&parse_mode=Markdown");
}
