<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiDi Coffee - Qu·∫£n Tr·ªã H·ªá Th·ªëng</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
    <div id="login-overlay">
        <h2>üîí X√ÅC TH·ª∞C</h2>
        <input type="password" id="adminPass" placeholder="Nh·∫≠p m√£ b·∫£o m·∫≠t">
        <button onclick="checkLogin()">V√ÄO H·ªÜ TH·ªêNG</button>
    </div>

    <div id="admin-content" style="display:none;">
        <h2>QU·∫¢N TR·ªä DIDI</h2>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="openTab(event, 'search')">KH√ÅCH H√ÄNG</button>
            <button class="tab-btn" onclick="openTab(event, 'gift')">QU√Ä T·∫∂NG</button>
            <button class="tab-btn" onclick="openTab(event, 'list')">DANH S√ÅCH</button>
        </div>

        <div id="search" class="section active">
            <label>S·ªë ƒëi·ªán tho·∫°i kh√°ch:</label>
            <input type="tel" id="searchPhone" placeholder="V√≠ d·ª•: 090xxx">
            <button id="btnSearch" onclick="fetchCust()">T√åM KI·∫æM</button>

            <div id="custInfo" style="display:none;" class="info-box">
                <p>Kh√°ch: <span id="resName">...</span></p>
                <p>ƒêi·ªÉm: <span id="resPoints" style="color:#d32f2f; font-size: 20px;">0</span></p>
                <hr style="border: 0.5px dashed #2e7d32; margin: 10px 0;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="addPoints" value="1" style="width: 80px; margin-bottom: 0;">
                    <button onclick="updatePoints('add')" style="padding: 10px; font-size: 14px;">‚ûï C·ªòNG ƒêI·ªÇM</button>
                </div>
            </div>
        </div>

        <div id="gift" class="section">
            <label>SƒêT Kh√°ch ƒë·ªïi qu√†:</label>
            <input type="tel" id="giftPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
            <label>T√™n m√≥n qu√†:</label>
            <input type="text" id="giftName" placeholder="VD: Ly Cafe Mu·ªëi / Voucher">
            <label>S·ªë ƒëi·ªÉm tr·ª´:</label>
            <input type="number" id="subPoints" placeholder="Nh·∫≠p s·ªë ƒëi·ªÉm c·∫ßn tr·ª´">
            <button class="btn-sub" onclick="updatePoints('sub')">X√ÅC NH·∫¨N ƒê·ªîI QU√Ä</button>
        </div>

        <div id="list" class="section">
            <button onclick="fetchAllCustomers()" style="margin-bottom: 10px; background: #2e7d32; font-size: 14px;">üîÑ T·∫¢I DANH S√ÅCH KH√ÅCH</button>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #d32f2f; border-radius: 8px;">
                <table class="cust-list-table">
                    <thead>
                        <tr>
                            <th>T√™n - SƒêT</th>
                            <th>ƒêi·ªÉm</th>
                        </tr>
                    </thead>
                    <tbody id="all-cust-body">
                        <tr><td colspan="2" style="text-align:center; padding: 20px;">Nh·∫•n n√∫t ƒë·ªÉ t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="statusMsg" style="margin-top: 15px; font-weight: bold; font-size: 13px; text-align: center;"></div>
</div>

<script src="config.js"></script>
<script>
    // 1. Ki·ªÉm tra ƒëƒÉng nh·∫≠p - ƒê√É S·ª¨A ƒê·ªÇ HI·ªÜN N·ªòI DUNG
    function checkLogin() {
        const pass = document.getElementById('adminPass').value;
        if(pass === "1234") { 
            document.getElementById('login-overlay').style.display = 'none'; // ·∫®n kh√≥a
            document.getElementById('admin-content').style.display = 'block'; // Hi·ªán n·ªôi dung qu·∫£n tr·ªã
        } else {
            alert("M√£ b·∫£o m·∫≠t kh√¥ng ƒë√∫ng!");
        }
    }

    // 2. Chuy·ªÉn Tab - GI·ªÆ NGUY√äN
    function openTab(evt, tabName) {
        let sections = document.getElementsByClassName("section");
        for (let s of sections) s.classList.remove("active");
        let tabs = document.getElementsByClassName("tab-btn");
        for (let t of tabs) t.classList.remove("active");
        
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
        document.getElementById('statusMsg').innerText = "";
    }

    // 3. T√¨m 1 kh√°ch h√†ng - GI·ªÆ NGUY√äN
    function fetchCust() {
        const phone = document.getElementById('searchPhone').value.trim();
        if(!phone) return;
        document.getElementById('statusMsg').innerText = "‚åõ ƒêang t√¨m...";
        fetch(`${CONFIG.SCRIPT_URL}?action=admin_get_info&phone=${phone}&callback=showCust`)
            .then(res => res.text()).then(txt => eval(txt));
    }

    function showCust(data) {
        document.getElementById('statusMsg').innerText = "";
        if(data.status === "SUCCESS") {
            document.getElementById('custInfo').style.display = 'block';
            document.getElementById('resName').innerText = data.name;
            document.getElementById('resPoints').innerText = data.points;
        } else {
            alert("Kh√¥ng t√¨m th·∫•y kh√°ch!");
        }
    }

    // 4. C·ªông ho·∫∑c Tr·ª´ ƒëi·ªÉm - GI·ªÆ NGUY√äN
    function updatePoints(mode) {
        const phone = (mode === 'add') ? document.getElementById('searchPhone').value : document.getElementById('giftPhone').value;
        const amount = (mode === 'add') ? document.getElementById('addPoints').value : document.getElementById('subPoints').value;
        const note = (mode === 'add') ? "Admin c·ªông ƒëi·ªÉm" : document.getElementById('giftName').value;
        const name = (mode === 'add') ? document.getElementById('resName').innerText : "Kh√°ch ƒë·ªïi qu√†";

        if(!phone || !amount) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!"); return; }

        document.getElementById('statusMsg').innerText = "‚åõ ƒêang x·ª≠ l√Ω...";
        fetch(`${CONFIG.SCRIPT_URL}?action=admin_update_points&mode=${mode}&phone=${phone}&amount=${amount}&name=${encodeURIComponent(name)}&note=${encodeURIComponent(note)}&callback=afterUpdate`)
            .then(res => res.text()).then(txt => eval(txt));
    }

    function afterUpdate(res) {
        if(res.status === "SUCCESS") {
            document.getElementById('statusMsg').innerText = "‚úÖ TH√ÄNH C√îNG!";
            document.getElementById('statusMsg').style.color = "green";
            if(document.getElementById('resPoints')) document.getElementById('resPoints').innerText = res.points;
            alert("Thao t√°c th√†nh c√¥ng! ƒêi·ªÉm hi·ªán t·∫°i: " + res.points);
        }
    }

    // 5. T·∫£i to√†n b·ªô danh s√°ch kh√°ch h√†ng - GI·ªÆ NGUY√äN
    function fetchAllCustomers() {
        document.getElementById('statusMsg').innerText = "‚åõ ƒêang qu√©t d·ªØ li·ªáu (c√≥ th·ªÉ m·∫•t v√†i gi√¢y)...";
        fetch(`${CONFIG.SCRIPT_URL}?action=admin_get_all_customers&callback=renderAllCust`)
            .then(res => res.text()).then(txt => eval(txt));
    }

    function renderAllCust(res) {
        const tbody = document.getElementById('all-cust-body');
        tbody.innerHTML = ""; 
        if(res.status === "SUCCESS") {
            document.getElementById('statusMsg').innerText = "‚úÖ ƒê√£ t·∫£i xong danh s√°ch.";
            res.data.sort((a, b) => b.points - a.points); 
            res.data.forEach(cust => {
                tbody.innerHTML += `<tr>
                    <td><strong>${cust.name}</strong><br><small>${cust.phone}</small></td>
                    <td style="color:#d32f2f; font-weight:bold;">${cust.points}</td>
                </tr>`;
            });
        }
    }
</script>
</body>
</html>
