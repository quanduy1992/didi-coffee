<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>DI DI COFFEE - V√≤ng Quay May M·∫Øn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="hoamai.js"></script>
    <style>
        .wheel-container, #wheel {
            position: relative;
            z-index: 99 !important; /* ƒê·∫£m b·∫£o v√≤ng quay lu√¥n n·∫±m tr√™n c√πng */
        }
        #wheel-container {
            position: relative;
            width: 300px;
            margin: 20px auto;
            z-index: 2;
        }
        #wheel {
            width: 100%;
            height: auto;
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        #pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            background: #d32f2f;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            z-index: 10;
            border-bottom: 2px solid #fff;
        }
    </style>
</head>
<body>
    <audio id="spinSound" loop preload="auto">
        <source src="https://www.soundjay.com/misc/sounds/wooden-rattle-1.mp3" type="audio/mpeg">
    </audio>
    <audio id="winSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" type="audio/mpeg">
    </audio>

    <div class="card"> 
        <h2 id="shopTitle">üé° V√íNG QUAY DI DI</h2>
        <p id="sub-title" style="color: #8d6e63; font-size: 14px; margin-top: -10px;">ƒêang t·∫£i c·∫•u h√¨nh...</p>
        
        <div id="wheel-container">
            <div id="pointer"></div>
            <canvas id="wheel" width="300" height="300"></canvas>
        </div>

        <div class="controls" id="form-input">
            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ quay">
            <button id="spinBtn" onclick="checkAndSpin()">QUAY NGAY</button>
        </div>

        <div id="result"></div>

        <div class="nav-menu">
            <a href="index.html" class="nav-item"><i>‚≠ê</i> T√≠ch ƒëi·ªÉm</a>
            <a href="doi-qua.html" class="nav-item"><i>üéÅ</i> ƒê·ªïi qu√†</a>
            <a href="vong-quay.html" class="nav-item active"><i>üé°</i> Quay th∆∞·ªüng</a>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const GIFTS = ["T·∫∑ng 1 ly", "T·∫∑ng 2 ly", "T·∫∑ng 7 ly", "T·∫∑ng 15 ly", "T·∫∑ng 20 Ly", "T·∫∑ng 30 ly", "T·∫∑ng gi·ªè qu√†", "Bao l√¨ x√¨"];
        const COLORS = ["#d32f2f", "#f1c40f", "#d32f2f", "#f1c40f", "#d32f2f", "#f1c40f", "#d32f2f", "#f1c40f"];
        const GIFT_DATA = [
            { name: "T·∫∑ng 1 ly", weight: 55 }, { name: "T·∫∑ng 2 ly", weight: 25 }, 
            { name: "T·∫∑ng 7 ly", weight: 15 }, { name: "T·∫∑ng 15 ly", weight: 3.3 },
            { name: "T·∫∑ng 20 Ly", weight: 1 }, { name: "T·∫∑ng 30 ly", weight: 0.5 }, 
            { name: "T·∫∑ng gi·ªè qu√†", weight: 0.1 }, { name: "Bao l√¨ x√¨", weight: 0.1 }
        ];

        let currentRotation = 0;
        const spinAudio = document.getElementById('spinSound');
        const winAudio = document.getElementById('winSound');

        function drawWheel() {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const arc = (Math.PI * 2) / GIFTS.length;
            ctx.clearRect(0, 0, 300, 300);
            ctx.save();
            ctx.translate(150, 150);
            ctx.rotate(-Math.PI / 2); 
            ctx.translate(-150, -150);
            GIFTS.forEach((gift, i) => {
                ctx.beginPath();
                ctx.fillStyle = COLORS[i];
                ctx.moveTo(150, 150);
                ctx.arc(150, 150, 145, i * arc, (i + 1) * arc);
                ctx.fill();
                ctx.strokeStyle = "#fff";
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.save();
                ctx.fillStyle = COLORS[i] === "#f1c40f" ? "#d32f2f" : "white";
                ctx.font = "bold 13px Arial";
                ctx.translate(150, 150);
                ctx.rotate(i * arc + arc / 2);
                ctx.textAlign = "right";
                ctx.fillText(gift, 130, 5);
                ctx.restore();
            });
            ctx.restore();
            ctx.beginPath();
            ctx.arc(150, 150, 15, 0, Math.PI * 2);
            ctx.fillStyle = "#fff";
            ctx.fill();
            ctx.stroke();
        }

        window.onload = function() {
            drawWheel();
            if (typeof CONFIG !== 'undefined' && CONFIG.SHOP_NAME) {
                document.getElementById('shopTitle').innerText = "üé° " + CONFIG.SHOP_NAME;
                document.getElementById('sub-title').innerText = `ƒê·ªïi ${CONFIG.SPIN_POINTS} l∆∞·ª£t t√≠ch l≈©y = 1 l∆∞·ª£t quay`;
            }
            const savedPhone = localStorage.getItem('didi_customer_phone') || localStorage.getItem('userPhone');
            if (savedPhone) document.getElementById('phone').value = savedPhone;
        };

        async function checkAndSpin() {
            const phoneInput = document.getElementById('phone');
            const btn = document.getElementById('spinBtn');
            const resDiv = document.getElementById('result');
            const phone = phoneInput.value.trim().replace(/[^0-9]/g, "");

            if (phone.length < 10) { 
                resDiv.innerHTML = "<div class='error'>‚ùå Vui l√≤ng nh·∫≠p ƒë√∫ng SƒêT!</div>";
                return; 
            }

            btn.disabled = true;
            btn.innerText = "‚åõ ƒêANG KI·ªÇM TRA...";
            resDiv.innerHTML = "";

            try {
                // 1. KI·ªÇM TRA ƒêI·ªÇM XONG M·ªöI QUAY
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=get_points&phone=${phone}`);
                const currentPoints = parseFloat(await response.text()) || 0;

                if (currentPoints >= CONFIG.SPIN_POINTS) {
                    localStorage.setItem('didi_customer_phone', phone);
                    
                    // 2. T√çNH TO√ÅN K·∫æT QU·∫¢
                    const totalWeight = GIFT_DATA.reduce((sum, item) => sum + item.weight, 0);
                    let random = Math.random() * totalWeight;
                    let selectedIndex = 0;
                    for (let i = 0; i < GIFT_DATA.length; i++) {
                        if (random < GIFT_DATA[i].weight) { selectedIndex = i; break; }
                        random -= GIFT_DATA[i].weight;
                    }
                    const giftName = GIFT_DATA[selectedIndex].name;

                    // 3. HI·ªÜU ·ª®NG QUAY (4 GI√ÇY)
                    spinAudio.currentTime = 0;
                    spinAudio.play();
                    const arc = 360 / GIFTS.length;
                    const targetDegree = 360 - (selectedIndex * arc + arc / 2);
                    currentRotation += 1440 + (targetDegree - (currentRotation % 360) + 360) % 360;
                    document.getElementById('wheel').style.transform = `rotate(${currentRotation}deg)`;
                    btn.innerText = "üé° ƒêANG QUAY...";

                    // 4. G·ª¨I K·∫æT QU·∫¢ L√äN SERVER NGAY (CH·∫†Y NG·∫¶M)
                    fetch(`${CONFIG.SCRIPT_URL}?action=vong_quay&phone=${phone}&gift=${encodeURIComponent(giftName)}&points=${CONFIG.SPIN_POINTS}`);

                    // 5. HI·ªÜN K·∫æT QU·∫¢ T·ª®C TH√å SAU ƒê√öNG 4 GI√ÇY
                    setTimeout(() => {
                        spinAudio.pause();
                        
                        // T·ª± t√≠nh s·ªë ƒëi·ªÉm c√≤n l·∫°i ƒë·ªÉ hi·ªÉn th·ªã ngay (kh√¥ng ƒë·ª£i server)
                        const estimatedNewPoints = currentPoints - CONFIG.SPIN_POINTS;
                        const now = new Date();
                        const timeStr = now.toLocaleDateString('vi-VN') + " " + now.toLocaleTimeString('vi-VN');

                        // TR·∫¢ K·∫æT QU·∫¢ NGAY L·∫¨P T·ª®C T·∫†I ƒê√ÇY
                        resDiv.innerHTML = `
                            <div class="success-box">
                                <div>${giftName === 'Ch√∫c May M·∫Øn' ? 'üçÄ' : 'üéâ'} ${giftName.toUpperCase()}</div>
                                <span class="time">Th·ªùi gian quay: ${timeStr}</span>
                                <span class="points-info">S·ªë ƒëi·ªÉm c√≤n l·∫°i: <span>${estimatedNewPoints}</span></span>
                            </div>
                        `;
                        
                        if (giftName !== "Ch√∫c May M·∫Øn") {
                            winAudio.currentTime = 0;
                            winAudio.play();
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        }
                        btn.disabled = false;
                        btn.innerText = "QUAY TI·∫æP";
                    }, 4000); // Kh·ªõp ho√†n to√†n v·ªõi th·ªùi gian transition CSS (4s)

                } else {
                    resDiv.innerHTML = `<div class='error'>‚ùå Kh√¥ng ƒë·ªß ƒëi·ªÉm! (Hi·ªán c√≥: ${currentPoints})</div>`;
                    btn.disabled = false;
                    btn.innerText = "QUAY NGAY";
                }
            } catch (e) {
                resDiv.innerHTML = "<div class='error'>‚ö†Ô∏è L·ªói k·∫øt n·ªëi!</div>";
                btn.disabled = false;
                btn.innerText = "TH·ª¨ L·∫†I";
            }
        }
    </script>
</body>
</html>




