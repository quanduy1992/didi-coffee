<!DOCTYPE html>
<html>
<head>
    <title>DI DI COFFEE - V√≤ng Quay May M·∫Øn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
<body>
    <div class="container">
        <h2>üé° V√íNG QUAY DI DI</h2>
        <p id="sub-title">ƒêang t·∫£i c·∫•u h√¨nh...</p>
        
        <div id="wheel-container">
            <div id="pointer"></div>
            <canvas id="wheel" width="300" height="300"></canvas>
        </div>

        <div class="controls">
            <input type="tel" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i (10 s·ªë)">
            <button id="spinBtn" onclick="checkAndSpin()">QUAY NGAY</button>
        </div>
        <div id="result"></div>
    </div>

    <script src="config.js"></script>

    <script>
        const GIFTS = ["Gi·∫£m 10%", "Topping", "T·∫∑ng 1 Ly", "May M·∫Øn", "Gi·∫£m 20k", "Th√™m 1 l∆∞·ª£t"];
        const COLORS = ["#f1c40f", "#e67e22", "#e74c3c", "#9b59b6", "#3498db", "#2ecc71"];
        let currentRotation = 0;

        function drawWheel() {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const arc = (Math.PI * 2) / GIFTS.length;
            GIFTS.forEach((gift, i) => {
                ctx.beginPath(); ctx.fillStyle = COLORS[i]; ctx.moveTo(150, 150);
                ctx.arc(150, 150, 150, i * arc, (i + 1) * arc); ctx.fill();
                ctx.save(); ctx.fillStyle = "white"; ctx.font = "bold 14px Arial";
                ctx.translate(150, 150); ctx.rotate(i * arc + arc / 2);
                ctx.fillText(gift, 75, 5); ctx.restore();
            });
        }

        window.onload = function() {
            if (typeof CONFIG !== 'undefined') {
                document.getElementById('sub-title').innerText = `ƒê·ªïi ${CONFIG.SPIN_POINTS} l∆∞·ª£t t√≠ch l≈©y = 1 l∆∞·ª£t quay`;
                drawWheel();
            }
        };

        async function checkAndSpin() {
            const phoneInput = document.getElementById('phone');
            const btn = document.getElementById('spinBtn');
            const resDiv = document.getElementById('result');
            const phone = phoneInput.value.trim().replace(/[^0-9]/g, "");

            if (phone.length < 10) { alert("Vui l√≤ng nh·∫≠p ƒë√∫ng SƒêT!"); return; }
            
            btn.disabled = true;
            resDiv.innerText = "‚è≥ ƒêang ki·ªÉm tra ƒëi·ªÉm...";

            try {
                // 1. Ki·ªÉm tra ƒëi·ªÉm t·ª´ Apps Script
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=get_points&phone=${phone}`);
                const currentPoints = parseInt(await response.text()) || 0;

                // 2. So s√°nh v·ªõi ƒëi·ªÉm y√™u c·∫ßu trong config.js
                if (currentPoints >= CONFIG.SPIN_POINTS) {
                    resDiv.innerText = "üé° ƒêang quay...";
                    const randomDegree = Math.floor(Math.random() * 360) + 1800;
                    currentRotation += randomDegree;
                    document.getElementById('wheel').style.transform = `rotate(${currentRotation}deg)`;

                    // G·ªçi l·ªánh tr·ª´ ƒëi·ªÉm tr√™n Sheets
                    fetch(CONFIG.SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({ action: "doi_thuong", phone: phone, points_required: CONFIG.SPIN_POINTS })
                    });

                    setTimeout(() => {
                        const actualDeg = currentRotation % 360;
                        const giftIndex = GIFTS.length - 1 - Math.floor(actualDeg / (360 / GIFTS.length));
                        resDiv.innerHTML = `üéâ Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c: <span style="color:#e74c3c">${GIFTS[giftIndex]}</span>`;
                        btn.disabled = false;
                    }, 4000);
                } else {
                    // 3. Th√¥ng b√°o kh√¥ng ƒë·ªß ƒëi·ªÉm
                    resDiv.innerHTML = `<span style="color:#e74c3c">‚ùå Kh√¥ng ƒë·ªß ƒëi·ªÉm! (B·∫°n c√≥ ${currentPoints}/${CONFIG.SPIN_POINTS})</span>`;
                    btn.disabled = false;
                }
            } catch (e) {
                resDiv.innerText = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i!";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>